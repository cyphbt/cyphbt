<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content=""
  />
  
    
      <title>Go singleflight 源码分析     | cyp&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="http://localhost:1313/">
      <img
        class="icon"
        src="/images/brandIcon.svg"
      />
    </a>
    <div class="text">
      <a href="http://localhost:1313/"><h1>cyp&#39;s Blog</h1></a>
      <h3>Description about Blog Author</h3>
    </div>
  </div>
  <nav>
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">Go singleflight 源码分析    </h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2025-08-07 17:40:00</time>
    
    
  </strong>
  <span> • 4305 words</span>
  <span> • 21 minute read</span>
  
  
</div>

      <div class="content"><hr>
<p><strong>User</strong></p>
<p>这是什么原因</p>
<hr>
<p><strong>Cursor</strong></p>
<p>我需要查看当前打开的文件内容以及相关的错误信息来帮助您诊断问题。让我先检查一下您当前正在查看的文件。</p>
<p>我看到您的光标在第73行，这是一个panic错误处理的位置。让我检查一下是否有任何编译错误或运行时错误信息。</p>
<p>让我检查一下项目的构建状态和可能的错误：</p>
<hr>
<p><strong>User</strong></p>
<p>翻一下</p>
<hr>
<p><strong>Cursor</strong></p>
<p>我看到您在查看 <code>singleflight</code> 包的代码。让我帮您翻译一下您选中的这段注释：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Do executes and returns the results of the given function, making</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sure that only one execution is in-flight for a given key at a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// time. If a duplicate comes in, the duplicate caller waits for the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// original to complete and receives the same results.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The return value shared indicates whether v was given to multiple callers.</span>
</span></span></code></pre></div><p><strong>中文翻译：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Do 执行给定的函数并返回结果，确保对于给定的 key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在同一时间只有一个执行在进行中。如果有重复的调用进来，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 重复的调用者会等待原始调用完成并接收相同的结果。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回值 shared 表示 v 是否被提供给了多个调用者。</span>
</span></span></code></pre></div><p>这是 <code>singleflight</code> 包中 <code>Do</code> 方法的核心功能说明。这个包主要用于防止缓存击穿，确保对于相同的 key，即使有多个并发请求，也只会执行一次实际的操作（比如数据库查询），其他请求会等待并共享这个结果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Do executes and returns the results of the given function, making</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sure that only one execution is in-flight for a given key at a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// time. If a duplicate comes in, the duplicate caller waits for the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// original to complete and receives the same results.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The return value shared indicates whether v was given to multiple callers.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Do 执行给定的函数并返回结果，确保对于给定的 key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在同一时间只有一个执行在进行中。如果有重复的调用进来，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 重复的调用者会等待原始调用完成并接收相同的结果。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回值 shared 表示 v 是否被提供给了多个调用者。</span>
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>翻译这里</p>
<hr>
<p><strong>Cursor</strong></p>
<p>我来帮您翻译这段注释：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// The first line of the stack trace is of the form &#34;goroutine N [status]:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// but by the time the panic reaches Do the goroutine may no longer exist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and its status will have changed. Trim out the misleading line.</span>
</span></span></code></pre></div><p><strong>中文翻译：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 堆栈跟踪的第一行格式是 &#34;goroutine N [status]:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 但是当 panic 到达 Do 方法时，goroutine 可能已经不存在了</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 并且它的状态会发生改变。需要去掉这个误导性的行。</span>
</span></span></code></pre></div><p>这段注释是在解释为什么要处理堆栈跟踪信息。在 Go 语言中，当发生 panic 时会产生堆栈跟踪，但由于并发执行的特性，当 panic 信息传递到 <code>Do</code> 方法时，原始的 goroutine 状态可能已经改变，所以需要过滤掉可能误导的第一行信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// The first line of the stack trace is of the form &#34;goroutine N [status]:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// but by the time the panic reaches Do the goroutine may no longer exist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and its status will have changed. Trim out the misleading line.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 堆栈跟踪的第一行格式是 &#34;goroutine N [status]:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 但是当 panic 到达 Do 方法时，goroutine 可能已经不存在了</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 并且它的状态会发生改变。需要去掉这个误导性的行。</span>
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>翻译这里</p>
<hr>
<p><strong>Cursor</strong></p>
<p>我来帮您翻译这段注释：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Ideally, we would wait to take a stack trace until we&#39;ve determined</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// whether this is a panic or a runtime.Goexit.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Unfortunately, the only way we can distinguish the two is to see</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// whether the recover stopped the goroutine from terminating, and by</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// the time we know that, the part of the stack trace relevant to the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// panic has been discarded.</span>
</span></span></code></pre></div><p><strong>中文翻译：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 理想情况下，我们应该等到确定这是一个 panic 还是 runtime.Goexit </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 之后再获取堆栈跟踪。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不幸的是，区分这两者的唯一方法是查看 recover 是否阻止了 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// goroutine 终止，但是当我们知道这一点时，与 panic 相关的</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 堆栈跟踪部分已经被丢弃了。</span>
</span></span></code></pre></div><p>这段注释解释了在处理 panic 和 <code>runtime.Goexit</code> 时面临的技术挑战：</p>
<ul>
<li><strong>理想状态</strong>：先判断是 panic 还是 Goexit，再决定是否获取堆栈跟踪</li>
<li><strong>实际困难</strong>：只能通过 <code>recover</code> 的效果来区分，但此时相关的堆栈信息已经丢失了</li>
</ul>
<p><code>runtime.Goexit</code> 是 Go 语言中用于终止当前 goroutine 的函数，它不会触发 defer 函数中的 recover，这与 panic 的行为不同。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Ideally, we would wait to take a stack trace until we&#39;ve determined</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// whether this is a panic or a runtime.Goexit.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Unfortunately, the only way we can distinguish the two is to see</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// whether the recover stopped the goroutine from terminating, and by</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// the time we know that, the part of the stack trace relevant to the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// panic has been discarded.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 理想情况下，我们应该等到确定这是一个 panic 还是 runtime.Goexit </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 之后再获取堆栈跟踪。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不幸的是，区分这两者的唯一方法是查看 recover 是否阻止了 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// goroutine 终止，但是当我们知道这一点时，与 panic 相关的</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 堆栈跟踪部分已经被丢弃了。</span>
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>这里为什么要这么做</p>
<hr>
<p><strong>Cursor</strong></p>
<p>这段代码的设计是为了处理一个很特殊的并发场景。让我解释一下为什么要这样做：</p>
<h2 id="问题背景">问题背景</h2>
<p>在 <code>singleflight</code> 中，当多个 goroutine 同时请求相同的 key 时：</p>
<ul>
<li>第一个 goroutine 执行实际的函数</li>
<li>其他 goroutine 通过 channel 等待结果</li>
</ul>
<h2 id="为什么需要特殊处理">为什么需要特殊处理</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// In order to prevent the waiting channels from being blocked forever,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// needs to ensure that this panic cannot be recovered.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 为了防止等待的 channel 被永久阻塞，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 需要确保这个 panic 不能被 recover。</span>
</span></span></code></pre></div><p><strong>关键问题</strong>：如果执行函数的 goroutine 发生了 panic，但这个 panic 被上层的 recover 捕获了，那么：</p>
<ol>
<li><strong>等待的 goroutine 会永远阻塞</strong> - 因为没有人会向它们的 channel 发送结果</li>
<li><strong>资源泄漏</strong> - 这些 goroutine 永远不会被释放</li>
</ol>
<h2 id="解决方案">解决方案</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">chans</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)  <span style="color:#75715e">// 在新的 goroutine 中重新 panic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}    <span style="color:#75715e">// 让当前 goroutine 永远阻塞，保留在崩溃转储中</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)     <span style="color:#75715e">// 没有等待者，直接 panic</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>为什么这样设计</strong>：</p>
<ol>
<li><strong><code>go panic(e)</code></strong> - 在新的 goroutine 中重新抛出 panic，这个新的 panic 不会被当前调用栈的 recover 捕获，确保程序会崩溃</li>
<li><strong><code>select {}</code></strong> - 让当前 goroutine 永远阻塞，这样在程序崩溃时的转储信息中还能看到这个 goroutine 的状态，便于调试</li>
<li><strong><code>len(c.chans) &gt; 0</code></strong> - 只有当有其他 goroutine 在等待时才需要这种特殊处理</li>
</ol>
<p>这是一种&quot;宁可崩溃也不要死锁&quot;的设计哲学，确保系统不会因为隐藏的 panic 而进入不可恢复的状态。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// In order to prevent the waiting channels from being blocked forever,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// needs to ensure that this panic cannot be recovered.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 为了防止等待的 channel 被永久阻塞，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 需要确保这个 panic 不能被 recover。</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">chans</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)  <span style="color:#75715e">// 在新的 goroutine 中重新 panic</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}    <span style="color:#75715e">// 让当前 goroutine 永远阻塞，保留在崩溃转储中</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)     <span style="color:#75715e">// 没有等待者，直接 panic</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>go panic(e)  // 在新的 goroutine 中重新 panic 这一行会造成什么后果？导致主 goroutine 崩溃吗？</p>
<hr>
<p><strong>Cursor</strong></p>
<p>很好的问题！让我详细解释 <code>go panic(e)</code> 的后果：</p>
<h2 id="go-panice-的后果"><code>go panic(e)</code> 的后果</h2>
<p><strong>是的，会导致整个程序崩溃，包括主 goroutine。</strong></p>
<h3 id="具体过程">具体过程：</h3>
<ol>
<li>
<p><strong>新 goroutine 立即 panic</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)  <span style="color:#75715e">// 启动一个新的 goroutine，这个 goroutine 立即执行 panic(e)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>无法被 recover 捕获</strong></p>
<ul>
<li>这个新 goroutine 中的 panic 不在任何 recover 的作用域内</li>
<li>因为它是全新的调用栈，与原来的调用栈完全独立</li>
</ul>
</li>
<li>
<p><strong>程序终止</strong></p>
<ul>
<li>当一个 goroutine 发生未被 recover 的 panic 时，整个程序会终止</li>
<li>这会影响所有 goroutine，包括主 goroutine</li>
</ul>
</li>
</ol>
<h3 id="为什么要这样设计">为什么要这样设计？</h3>
<p>这是一个<strong>故意的设计决策</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 伪代码说明意图</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">有其他goroutine在等待</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 情况1：让程序崩溃，避免死锁</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)      <span style="color:#75715e">// 确保程序崩溃</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}        <span style="color:#75715e">// 保持当前goroutine存活，便于调试</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 情况2：没有等待者，直接panic</span>
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)         <span style="color:#75715e">// 正常的panic处理</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="设计理念">设计理念</h3>
<p>这体现了 Go 语言中的一个重要原则：<strong>&ldquo;Don&rsquo;t hide errors that will cause problems later&rdquo;</strong></p>
<ul>
<li><strong>如果让 panic 被 recover</strong>：等待的 goroutine 会永远阻塞，造成更严重的问题</li>
<li><strong>如果让程序崩溃</strong>：虽然程序终止了，但问题会立即暴露，便于修复</li>
</ul>
<h3 id="实际影响">实际影响</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 singleflight 中发生了这种情况</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 整个程序会打印 panic 信息并退出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 类似于：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// panic: some error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// goroutine 123 [running]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...stack trace...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>所以是的，<code>go panic(e)</code> 会导致整个程序（包括主 goroutine）崩溃，这是有意为之的设计。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>   <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)  <span style="color:#75715e">// 启动一个新的 goroutine，这个 goroutine 立即执行 panic(e)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 伪代码说明意图</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">有其他goroutine在等待</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 情况1：让程序崩溃，避免死锁</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)      <span style="color:#75715e">// 确保程序崩溃</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}        <span style="color:#75715e">// 保持当前goroutine存活，便于调试</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 情况2：没有等待者，直接panic</span>
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)         <span style="color:#75715e">// 正常的panic处理</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 singleflight 中发生了这种情况</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 整个程序会打印 panic 信息并退出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 类似于：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// panic: some error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// goroutine 123 [running]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...stack trace...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>既然整个程序会崩溃，那这里为什么要 select {}     select {}        // 保持当前goroutine存活，便于调试</p>
<hr>
<p><strong>Cursor</strong></p>
<p>很好的观察！这确实看起来有些矛盾。让我解释一下为什么需要 <code>select {}</code>：</p>
<h2 id="时序问题">时序问题</h2>
<p>关键在于<strong>程序崩溃不是瞬间发生的</strong>，有一个时间窗口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine，但需要时间调度执行</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 立即阻塞当前goroutine</span>
</span></span></code></pre></div><h3 id="没有-select--会发生什么">没有 <code>select {}</code> 会发生什么：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 函数结束，当前goroutine继续执行或退出</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可能在新goroutine panic之前就已经清理完毕</span>
</span></span></code></pre></div><p><strong>问题</strong>：当前 goroutine 可能会：</p>
<ol>
<li>继续执行后续代码</li>
<li>函数返回</li>
<li>goroutine 退出</li>
<li>调用栈信息丢失</li>
</ol>
<h3 id="有了-select--的效果">有了 <code>select {}</code> 的效果：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 当前goroutine永远阻塞在这里</span>
</span></span></code></pre></div><p><strong>好处</strong>：</p>
<ol>
<li><strong>保持调用栈</strong>：当前 goroutine 会一直存在，调用栈信息不会丢失</li>
<li><strong>完整的崩溃信息</strong>：程序崩溃时能看到完整的 goroutine 状态</li>
<li><strong>便于调试</strong>：可以看到是从哪里触发的 panic</li>
</ol>
<h2 id="实际的调试价值">实际的调试价值</h2>
<h3 id="没有-select-">没有 <code>select {}</code>：</h3>
<pre tabindex="0"><code>panic: some error

goroutine 456 [running]:    // 只能看到新goroutine的信息
main.newGoroutine()
    /some/path/file.go:123
</code></pre><h3 id="有了-select-">有了 <code>select {}</code>：</h3>
<pre tabindex="0"><code>panic: some error

goroutine 456 [running]:    // 新goroutine的panic
main.newGoroutine()
    /some/path/file.go:123

goroutine 123 [select]:     // 原始goroutine还在，能看到完整调用链
golang.org/x/sync/singleflight.(*Group).Do()
    /path/to/singleflight.go:159
main.someFunction()         // 能看到是谁调用了singleflight
    /your/code/file.go:456
</code></pre><h2 id="总结">总结</h2>
<p><code>select {}</code> 的作用是<strong>在程序崩溃前保持当前 goroutine 的存在</strong>，这样在崩溃转储中就能看到：</p>
<ul>
<li>谁调用了 singleflight</li>
<li>完整的调用链</li>
<li>更丰富的调试信息</li>
</ul>
<p>这是一种&quot;临终前保留证据&quot;的做法，虽然程序要崩溃，但要让崩溃信息尽可能有用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine，但需要时间调度执行</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 立即阻塞当前goroutine</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 函数结束，当前goroutine继续执行或退出</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可能在新goroutine panic之前就已经清理完毕</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 启动新goroutine</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 当前goroutine永远阻塞在这里</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>panic: some error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 456 [running]:    // 只能看到新goroutine的信息
</span></span><span style="display:flex;"><span>main.newGoroutine()
</span></span><span style="display:flex;"><span>    /some/path/file.go:123
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>panic: some error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 456 [running]:    // 新goroutine的panic
</span></span><span style="display:flex;"><span>main.newGoroutine()
</span></span><span style="display:flex;"><span>    /some/path/file.go:123
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 123 [select]:     // 原始goroutine还在，能看到完整调用链
</span></span><span style="display:flex;"><span>golang.org/x/sync/singleflight.(*Group).Do()
</span></span><span style="display:flex;"><span>    /path/to/singleflight.go:159
</span></span><span style="display:flex;"><span>main.someFunction()         // 能看到是谁调用了singleflight
</span></span><span style="display:flex;"><span>    /your/code/file.go:456
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>崩溃转储 是什么意思</p>
<hr>
<p><strong>Cursor</strong></p>
<p>崩溃转储（Crash Dump）是程序崩溃时生成的详细信息报告。让我详细解释一下：</p>
<h2 id="什么是崩溃转储">什么是崩溃转储</h2>
<p>当 Go 程序发生 panic 时，runtime 会自动生成一份详细的报告，包含：</p>
<h3 id="1-panic-信息">1. <strong>Panic 信息</strong></h3>
<pre tabindex="0"><code>panic: runtime error: invalid memory address or nil pointer dereference
</code></pre><h3 id="2-调用栈信息stack-trace">2. <strong>调用栈信息（Stack Trace）</strong></h3>
<pre tabindex="0"><code>goroutine 1 [running]:
main.someFunction(0x0)
    /path/to/your/file.go:42 +0x1a
main.main()
    /path/to/your/file.go:15 +0x2f
</code></pre><h3 id="3-所有-goroutine-的状态">3. <strong>所有 Goroutine 的状态</strong></h3>
<pre tabindex="0"><code>goroutine 1 [running]:           // 主goroutine正在运行
main.main()
    /path/to/main.go:10

goroutine 2 [select]:            // 另一个goroutine在select等待
golang.org/x/sync/singleflight.(*Group).Do()
    /path/to/singleflight.go:159

goroutine 3 [chan receive]:      // 第三个goroutine在等待channel
main.worker()
    /path/to/worker.go:25
</code></pre><h2 id="实际例子">实际例子</h2>
<p>当程序崩溃时，你在终端会看到类似这样的输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go run main.go
</span></span><span style="display:flex;"><span>panic: something went wrong
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ae81ff">1</span> <span style="color:#f92672">[</span>running<span style="color:#f92672">]</span>:
</span></span><span style="display:flex;"><span>main.badFunction<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    /Users/cyp/project/main.go:15 +0x95
</span></span><span style="display:flex;"><span>main.main<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    /Users/cyp/project/main.go:8 +0x25
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#ae81ff">18</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">select</span><span style="color:#f92672">]</span>:
</span></span><span style="display:flex;"><span>golang.org/x/sync/singleflight.<span style="color:#f92672">(</span>*Group<span style="color:#f92672">)</span>.Do<span style="color:#f92672">(</span>0xc000010180, 0x4b0a20, 0x5, 0x4b7c60, 0x0, 0x0, 0x0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    /Users/cyp/go/pkg/mod/golang.org/x/sync@v0.1.0/singleflight/singleflight.go:159 +0x3c5
</span></span><span style="display:flex;"><span>main.getData<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    /Users/cyp/project/cache.go:42 +0x127
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit status <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><h2 id="为什么崩溃转储很重要">为什么崩溃转储很重要</h2>
<h3 id="1-定位问题">1. <strong>定位问题</strong></h3>
<ul>
<li>能准确看到是在哪一行代码出错</li>
<li>完整的函数调用链</li>
</ul>
<h3 id="2-并发调试">2. <strong>并发调试</strong></h3>
<ul>
<li>看到所有 goroutine 的状态</li>
<li>理解并发执行时的情况</li>
</ul>
<h3 id="3-生产环境排错">3. <strong>生产环境排错</strong></h3>
<ul>
<li>程序崩溃时留下的&quot;遗言&quot;</li>
<li>帮助开发者重现和修复 bug</li>
</ul>
<h2 id="在-singleflight-中的意义">在 singleflight 中的意义</h2>
<p>回到之前的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">chans</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 新goroutine会出现在崩溃转储中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 当前goroutine也会出现，状态是[select]</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>没有 <code>select {}</code></strong>：崩溃转储可能只显示新 goroutine 的信息
<strong>有了 <code>select {}</code></strong>：崩溃转储会显示两个 goroutine，提供更完整的调试信息</p>
<p>这就像是程序崩溃时的&quot;黑匣子&quot;，记录了崩溃瞬间的所有重要信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>panic: runtime error: invalid memory address or nil pointer dereference
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>goroutine 1 [running]:
</span></span><span style="display:flex;"><span>main.someFunction(0x0)
</span></span><span style="display:flex;"><span>    /path/to/your/file.go:42 +0x1a
</span></span><span style="display:flex;"><span>main.main()
</span></span><span style="display:flex;"><span>    /path/to/your/file.go:15 +0x2f
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>goroutine 1 [running]:           // 主goroutine正在运行
</span></span><span style="display:flex;"><span>main.main()
</span></span><span style="display:flex;"><span>    /path/to/main.go:10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 2 [select]:            // 另一个goroutine在select等待
</span></span><span style="display:flex;"><span>golang.org/x/sync/singleflight.(*Group).Do()
</span></span><span style="display:flex;"><span>    /path/to/singleflight.go:159
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 3 [chan receive]:      // 第三个goroutine在等待channel
</span></span><span style="display:flex;"><span>main.worker()
</span></span><span style="display:flex;"><span>    /path/to/worker.go:25
</span></span></code></pre></div><pre tabindex="0"><code class="language-shellscript" data-lang="shellscript">$ go run main.go
panic: something went wrong

goroutine 1 [running]:
main.badFunction()
    /Users/cyp/project/main.go:15 +0x95
main.main()
    /Users/cyp/project/main.go:8 +0x25

goroutine 18 [select]:
golang.org/x/sync/singleflight.(*Group).Do(0xc000010180, 0x4b0a20, 0x5, 0x4b7c60, 0x0, 0x0, 0x0)
    /Users/cyp/go/pkg/mod/golang.org/x/sync@v0.1.0/singleflight/singleflight.go:159 +0x3c5
main.getData()
    /Users/cyp/project/cache.go:42 +0x127

exit status 2
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">chans</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> panic(<span style="color:#a6e22e">e</span>)    <span style="color:#75715e">// 新goroutine会出现在崩溃转储中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}      <span style="color:#75715e">// 当前goroutine也会出现，状态是[select]</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    panic(<span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>主进程崩溃退出后，所有gorutine也都退出是怎么实现的</p>
<hr>
<p><strong>Cursor</strong></p>
<p>很好的问题！这涉及到 Go runtime 的进程管理机制。让我详细解释一下：</p>
<h2 id="go-runtime-的进程模型">Go Runtime 的进程模型</h2>
<h3 id="1-进程级别的管理">1. <strong>进程级别的管理</strong></h3>
<p>Go 程序本质上是一个<strong>操作系统进程</strong>，所有 goroutine 都运行在这个进程内：</p>
<pre tabindex="0"><code>┌─────────────────────────────────────┐
│           Go 进程                    │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐│
│  │goroutine│  │goroutine│  │goroutine││
│  │    1    │  │    2    │  │    3    ││
│  └─────────┘  └─────────┘  └─────────┘│
│                                       │
│         Go Runtime                    │
└─────────────────────────────────────────┘
</code></pre><h3 id="2-panic-处理机制">2. <strong>Panic 处理机制</strong></h3>
<p>当任何一个 goroutine 发生<strong>未被 recover 的 panic</strong> 时：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 伪代码展示 runtime 的处理逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handlePanic</span>(<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goroutine</span>, <span style="color:#a6e22e">panicValue</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">recovered</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1. 打印 panic 信息和堆栈</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printPanicInfo</span>(<span style="color:#a6e22e">panicValue</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printStackTrace</span>(<span style="color:#a6e22e">g</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2. 打印所有 goroutine 状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printAllGoroutines</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3. 终止整个进程</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">2</span>)  <span style="color:#75715e">// 进程退出</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3-进程退出的底层实现">3. <strong>进程退出的底层实现</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// runtime/panic.go (简化版)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">fatalpanic</span>(<span style="color:#a6e22e">msgs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_panic</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 打印 panic 信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printpanics</span>(<span style="color:#a6e22e">msgs</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是主 goroutine panic，或者没有其他用户 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">islockdowned</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">panicking</span>) &gt; <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 直接退出进程</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 否则也会最终导致进程退出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">systemstack</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="为什么所有-goroutine-都会退出">为什么所有 Goroutine 都会退出</h2>
<h3 id="1-操作系统层面">1. <strong>操作系统层面</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 当 Go 进程调用 exit(2) 时</span>
</span></span><span style="display:flex;"><span>kill -9 &lt;pid&gt;  <span style="color:#75715e"># 操作系统强制终止整个进程</span>
</span></span></code></pre></div><p>所有属于这个进程的线程（包括运行 goroutine 的 OS 线程）都会被操作系统回收。</p>
<h3 id="2-go-runtime-层面">2. <strong>Go Runtime 层面</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 当 panic 发生时，runtime 会：</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果没有 recover，runtime 会：</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 1. 停止调度器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2. 停止垃圾回收器  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 3. 调用 os.Exit(2)</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3-实际的执行流程">3. <strong>实际的执行流程</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demonstratePanic</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 1 开始&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)  <span style="color:#75715e">// 这个永远不会完成</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 1 结束&#34;</span>) <span style="color:#75715e">// 这行不会执行</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 2 开始&#34;</span>)
</span></span><span style="display:flex;"><span>        panic(<span style="color:#e6db74">&#34;崩溃了!&#34;</span>)  <span style="color:#75715e">// 这里 panic</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;主函数结束&#34;</span>)  <span style="color:#75715e">// 这行也不会执行</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>输出结果</strong>：</p>
<pre tabindex="0"><code>Goroutine 1 开始
Goroutine 2 开始
panic: 崩溃了!

goroutine 6 [running]:
main.demonstratePanic.func2()
    /path/to/file.go:XX +0x39
created by main.demonstratePanic
    /path/to/file.go:XX +0x5a

exit status 2
</code></pre><h2 id="特殊情况">特殊情况</h2>
<h3 id="1-被-recover-捕获的-panic">1. <strong>被 recover 捕获的 panic</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;捕获了 panic:&#34;</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 程序继续运行，其他 goroutine 不受影响</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    panic(<span style="color:#e6db74">&#34;这个 panic 被捕获了&#34;</span>)
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></div><h3 id="2-主-goroutine-退出">2. <strong>主 goroutine 退出</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;这行不会打印&#34;</span>)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;主函数结束&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// main 函数结束，整个程序退出，其他 goroutine 也会被终止</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结-1">总结</h2>
<p>Go 的设计哲学是：<strong>一个 goroutine 的未处理 panic 会导致整个程序崩溃</strong>，这是通过：</p>
<ol>
<li><strong>Runtime 检测</strong>：检测到未被 recover 的 panic</li>
<li><strong>进程终止</strong>：调用 <code>os.Exit(2)</code> 终止整个进程</li>
<li><strong>操作系统回收</strong>：OS 回收进程的所有资源，包括所有线程和 goroutine</li>
</ol>
<p>这确保了程序不会因为一个 goroutine 的错误而进入不可预知的状态。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>┌─────────────────────────────────────┐
</span></span><span style="display:flex;"><span>│           Go 进程                    │
</span></span><span style="display:flex;"><span>│  ┌─────────┐  ┌─────────┐  ┌─────────┐│
</span></span><span style="display:flex;"><span>│  │goroutine│  │goroutine│  │goroutine││
</span></span><span style="display:flex;"><span>│  │    1    │  │    2    │  │    3    ││
</span></span><span style="display:flex;"><span>│  └─────────┘  └─────────┘  └─────────┘│
</span></span><span style="display:flex;"><span>│                                       │
</span></span><span style="display:flex;"><span>│         Go Runtime                    │
</span></span><span style="display:flex;"><span>└─────────────────────────────────────────┘
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 伪代码展示 runtime 的处理逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handlePanic</span>(<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goroutine</span>, <span style="color:#a6e22e">panicValue</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">recovered</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1. 打印 panic 信息和堆栈</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printPanicInfo</span>(<span style="color:#a6e22e">panicValue</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printStackTrace</span>(<span style="color:#a6e22e">g</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2. 打印所有 goroutine 状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printAllGoroutines</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3. 终止整个进程</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">2</span>)  <span style="color:#75715e">// 进程退出</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// runtime/panic.go (简化版)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">fatalpanic</span>(<span style="color:#a6e22e">msgs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_panic</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 打印 panic 信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printpanics</span>(<span style="color:#a6e22e">msgs</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是主 goroutine panic，或者没有其他用户 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">islockdowned</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">panicking</span>) &gt; <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 直接退出进程</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 否则也会最终导致进程退出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">systemstack</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-shellscript" data-lang="shellscript"># 当 Go 进程调用 exit(2) 时
kill -9 &lt;pid&gt;  # 操作系统强制终止整个进程
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 当 panic 发生时，runtime 会：</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果没有 recover，runtime 会：</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 1. 停止调度器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2. 停止垃圾回收器  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 3. 调用 os.Exit(2)</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demonstratePanic</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 1 开始&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)  <span style="color:#75715e">// 这个永远不会完成</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 1 结束&#34;</span>) <span style="color:#75715e">// 这行不会执行</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Goroutine 2 开始&#34;</span>)
</span></span><span style="display:flex;"><span>        panic(<span style="color:#e6db74">&#34;崩溃了!&#34;</span>)  <span style="color:#75715e">// 这里 panic</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;主函数结束&#34;</span>)  <span style="color:#75715e">// 这行也不会执行</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Goroutine 1 开始
</span></span><span style="display:flex;"><span>Goroutine 2 开始
</span></span><span style="display:flex;"><span>panic: 崩溃了!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine 6 [running]:
</span></span><span style="display:flex;"><span>main.demonstratePanic.func2()
</span></span><span style="display:flex;"><span>    /path/to/file.go:XX +0x39
</span></span><span style="display:flex;"><span>created by main.demonstratePanic
</span></span><span style="display:flex;"><span>    /path/to/file.go:XX +0x5a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit status 2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;捕获了 panic:&#34;</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 程序继续运行，其他 goroutine 不受影响</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    panic(<span style="color:#e6db74">&#34;这个 panic 被捕获了&#34;</span>)
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;这行不会打印&#34;</span>)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;主函数结束&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// main 函数结束，整个程序退出，其他 goroutine 也会被终止</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>对于 singleflight，在实际使用时有什么最佳事件？比如声明一个全局的 singleflight 对象？</p>
<hr>
<p><strong>Cursor</strong></p>
<p>很好的问题！<code>singleflight</code> 的最佳实践确实很重要。让我详细介绍一下：</p>
<h2 id="1-全局-vs-局部声明">1. 全局 vs 局部声明</h2>
<h3 id="-推荐全局或包级别声明">✅ <strong>推荐：全局或包级别声明</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局声明，整个包共享</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">g</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserInfo</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 实际的数据库查询或API调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="-不推荐函数内局部声明">❌ <strong>不推荐：函数内局部声明</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserInfo</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">g</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 每次调用都创建新的，失去了去重效果</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="2-实际项目中的最佳实践">2. 实际项目中的最佳实践</h2>
<h3 id="方案一按业务模块分组"><strong>方案一：按业务模块分组</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 每个服务有自己的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sfGroup</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">OrderService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 订单服务独立的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="方案二全局缓存管理器"><strong>方案二：全局缓存管理器</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CacheManager</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userGroup</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">orderGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按业务类型分组，避免不同业务的key冲突</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DefaultCacheManager</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CacheManager</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DefaultCacheManager</span>.<span style="color:#a6e22e">userGroup</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">id</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-在您的项目中的应用">3. 在您的项目中的应用</h2>
<p>基于您的 <code>baseCache</code> 项目结构，推荐这样使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局声明，整个包共享</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">g</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserInfo</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 实际的数据库查询或API调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserInfo</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">g</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 每次调用都创建新的，失去了去重效果</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 每个服务有自己的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">sfGroup</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">OrderService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 订单服务独立的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CacheManager</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userGroup</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">orderGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按业务类型分组，避免不同业务的key冲突</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DefaultCacheManager</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CacheManager</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DefaultCacheManager</span>.<span style="color:#a6e22e">userGroup</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">id</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>基于您的项目结构，推荐这样改进：</p>
<h3 id="推荐实现方案"><strong>推荐实现方案</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/common/singleflight.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局的 singleflight 分组管理</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ClassroomSF</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">UserCenterSF</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WalletSF</span>     <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VideoSF</span>      <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按业务模块分组</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 在 app/biz/classroom/repository/redisRepo/classroom.go 中使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">redisRepo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;baseCache/app/common&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClassRoomRepo</span>) <span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">planId</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;plan_info_%d&#34;</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 singleflight 防止缓存击穿</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ClassroomSF</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 先查 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cached</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>); <span style="color:#a6e22e">cached</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cached</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Redis 没有，查数据库并写入 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">plan</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromDB</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setPlanInfoToRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>, <span style="color:#a6e22e">plan</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">plan</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 可以记录是否是共享结果，用于监控</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;singleflight shared result&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="4-高级最佳实践">4. 高级最佳实践</h2>
<h3 id="带超时控制"><strong>带超时控制</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 channel 实现超时</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>  <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">result</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="监控和指标"><strong>监控和指标</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithMetrics</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录指标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">duration</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightHit</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightMiss</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightDuration</span>.<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">duration</span>.<span style="color:#a6e22e">Seconds</span>())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="5-注意事项">5. 注意事项</h2>
<h3 id="key-的设计"><strong>Key 的设计</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ✅ 好的 key 设计</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:info:%d&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;order:detail:%s&#34;</span>, <span style="color:#a6e22e">orderID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ❌ 避免 key 冲突</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#a6e22e">id</span>)  <span style="color:#75715e">// 太简单，可能冲突</span>
</span></span></code></pre></div><h3 id="错误处理"><strong>错误处理</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 区分可重试和不可重试的错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fetchFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isRetryableError</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>  <span style="color:#75715e">// 返回错误，其他等待者也会收到错误</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 对于不可重试的错误，可能需要特殊处理</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>总结：<strong>推荐使用全局或包级别的 singleflight，按业务模块分组，配合适当的监控和错误处理。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/common/singleflight.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局的 singleflight 分组管理</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ClassroomSF</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">UserCenterSF</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WalletSF</span>     <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VideoSF</span>      <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按业务模块分组</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 在 app/biz/classroom/repository/redisRepo/classroom.go 中使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">redisRepo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;baseCache/app/common&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClassRoomRepo</span>) <span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">planId</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;plan_info_%d&#34;</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 singleflight 防止缓存击穿</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ClassroomSF</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 先查 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cached</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>); <span style="color:#a6e22e">cached</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cached</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Redis 没有，查数据库并写入 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">plan</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromDB</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setPlanInfoToRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>, <span style="color:#a6e22e">plan</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">plan</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 可以记录是否是共享结果，用于监控</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;singleflight shared result&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 channel 实现超时</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>  <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">result</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithMetrics</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录指标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">duration</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightHit</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightMiss</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightDuration</span>.<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">duration</span>.<span style="color:#a6e22e">Seconds</span>())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/common/singleflight.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局的 singleflight 分组管理</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ClassroomSF</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">UserCenterSF</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WalletSF</span>     <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VideoSF</span>      <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按业务模块分组</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 在 app/biz/classroom/repository/redisRepo/classroom.go 中使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">redisRepo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;baseCache/app/common&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClassRoomRepo</span>) <span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">planId</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;plan_info_%d&#34;</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 singleflight 防止缓存击穿</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ClassroomSF</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 先查 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cached</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>); <span style="color:#a6e22e">cached</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cached</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Redis 没有，查数据库并写入 Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">plan</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getPlanInfoFromDB</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setPlanInfoToRedis</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">planId</span>, <span style="color:#a6e22e">plan</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">plan</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 可以记录是否是共享结果，用于监控</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;singleflight shared result&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 channel 实现超时</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>  <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">result</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithMetrics</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录指标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">duration</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shared</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightHit</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightMiss</span>.<span style="color:#a6e22e">Inc</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">SingleflightDuration</span>.<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">duration</span>.<span style="color:#a6e22e">Seconds</span>())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ✅ 好的 key 设计</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:info:%d&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;order:detail:%s&#34;</span>, <span style="color:#a6e22e">orderID</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ❌ 避免 key 冲突</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#a6e22e">id</span>)  <span style="color:#75715e">// 太简单，可能冲突</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 区分可重试和不可重试的错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fetchFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isRetryableError</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>  <span style="color:#75715e">// 返回错误，其他等待者也会收到错误</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 对于不可重试的错误，可能需要特殊处理</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>在你的 方案一：按业务模块分组 中，我看到 这种定义 ，那么这种情况在 UserService 是单例实现的时候才有效吧？如果每次请求过来新获取一个 UserService 是不是就没有用了？</p>
<hr>
<p><strong>Cursor</strong></p>
<p>非常好的观察！您说得完全正确！这是一个非常重要的细节。</p>
<h2 id="问题分析">问题分析</h2>
<p>如果 <code>UserService</code> 不是单例，每次请求都创建新实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ❌ 错误的使用方式</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}  <span style="color:#75715e">// 每次都创建新实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)  <span style="color:#75715e">// singleflight 失效！</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>每个新的 <code>UserService</code> 实例都有自己独立的 <code>sfGroup</code>，完全失去了 singleflight 的去重效果。</p>
<h2 id="正确的实现方式">正确的实现方式</h2>
<h3 id="方案一确保服务是单例"><strong>方案一：确保服务是单例</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局单例</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userServiceInstance</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserService</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">userServiceInstance</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">userServiceInstance</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserService</span>()  <span style="color:#75715e">// 获取单例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="方案二将-singleflight-提取到包级别推荐"><strong>方案二：将 singleflight 提取到包级别（推荐）</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 包级别的 singleflight，所有 UserService 实例共享</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userSingleflight</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 其他字段，不包含 sfGroup</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用包级别的 singleflight</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userSingleflight</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这样即使每次创建新的 UserService 实例也没问题</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}  <span style="color:#75715e">// 新实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)  <span style="color:#75715e">// singleflight 仍然有效</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="方案三依赖注入模式"><strong>方案三：依赖注入模式</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 注入的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>(<span style="color:#a6e22e">sf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sfGroup</span>: <span style="color:#a6e22e">sf</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在应用启动时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 全局的 singleflight 实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userSF</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>{}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注入到服务中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>(<span style="color:#a6e22e">userSF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 或者使用依赖注入框架</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="在您的项目中的建议">在您的项目中的建议</h2>
<p>基于您的 <code>baseCache</code> 项目，我建议采用 <strong>方案二</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/common/singleflight.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按业务模块定义包级别的 singleflight</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ClassroomSF</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">UserCenterSF</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WalletSF</span>     <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VideoSF</span>      <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/biz/classroom/service/service.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;baseCache/app/common&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ClassroomService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不包含 singleflight 字段</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClassroomService</span>) <span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#a6e22e">planId</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;plan_info_%d&#34;</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用全局的 ClassroomSF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ClassroomSF</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchPlanFromDB</span>(<span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这样无论如何创建 ClassroomService 实例都没问题</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleClassroomRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ClassroomService</span>{}  <span style="color:#75715e">// 新实例也能正确使用 singleflight</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">plan</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结-2">总结</h2>
<p>您的观察完全正确！在使用 singleflight 时：</p>
<ol>
<li><strong>如果放在 struct 中</strong>：必须确保该 struct 是单例</li>
<li><strong>推荐做法</strong>：将 singleflight 定义在包级别，让所有实例共享</li>
<li><strong>这样即使每次创建新的服务实例，singleflight 的去重效果依然有效</strong></li>
</ol>
<p>这是一个很容易被忽视但非常重要的实现细节！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ❌ 错误的使用方式</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}  <span style="color:#75715e">// 每次都创建新实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)  <span style="color:#75715e">// singleflight 失效！</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局单例</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userServiceInstance</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserService</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">userServiceInstance</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">userServiceInstance</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserService</span>()  <span style="color:#75715e">// 获取单例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 包级别的 singleflight，所有 UserService 实例共享</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userSingleflight</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 其他字段，不包含 sfGroup</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用包级别的 singleflight</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userSingleflight</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这样即使每次创建新的 UserService 实例也没问题</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{}  <span style="color:#75715e">// 新实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#e6db74">&#34;123&#34;</span>)  <span style="color:#75715e">// singleflight 仍然有效</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sfGroup</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>  <span style="color:#75715e">// 注入的 singleflight</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserService</span>(<span style="color:#a6e22e">sf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserService</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sfGroup</span>: <span style="color:#a6e22e">sf</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在应用启动时</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 全局的 singleflight 实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userSF</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>{}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注入到服务中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewUserService</span>(<span style="color:#a6e22e">userSF</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 或者使用依赖注入框架</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/common/singleflight.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/sync/singleflight&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按业务模块定义包级别的 singleflight</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ClassroomSF</span>  <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">UserCenterSF</span> <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">WalletSF</span>     <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VideoSF</span>      <span style="color:#a6e22e">singleflight</span>.<span style="color:#a6e22e">Group</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// app/biz/classroom/service/service.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;baseCache/app/common&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ClassroomService</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不包含 singleflight 字段</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClassroomService</span>) <span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#a6e22e">planId</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;plan_info_%d&#34;</span>, <span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用全局的 ClassroomSF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ClassroomSF</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fetchPlanFromDB</span>(<span style="color:#a6e22e">planId</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">PlanInfo</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这样无论如何创建 ClassroomService 实例都没问题</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleClassroomRequest</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ClassroomService</span>{}  <span style="color:#75715e">// 新实例也能正确使用 singleflight</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">plan</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">GetPlanInfo</span>(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p><strong>User</strong></p>
<p>在 带超时控制 的实现中，为什么要新启动一个 goroutine？</p>
<hr>
<p><strong>Cursor</strong></p>
<p>非常好的问题！这涉及到 <code>singleflight.Do()</code> 方法的阻塞特性。让我详细解释一下：</p>
<h2 id="问题的核心">问题的核心</h2>
<p><code>singleflight.Do()</code> 是一个<strong>阻塞调用</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// singleflight.Do() 的行为</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这个函数可能执行很久</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)  <span style="color:#75715e">// 假设数据库查询很慢</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在函数执行完之前，这里不会被执行</span>
</span></span></code></pre></div><h2 id="如果不使用-goroutine-会怎样">如果不使用 goroutine 会怎样？</h2>
<h3 id="-错误的实现">❌ <strong>错误的实现</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 直接调用，没有 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)  <span style="color:#75715e">// 假设这需要 10 秒</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 问题：这个 select 永远不会被执行到！</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 因为上面的 g.Do() 会阻塞 10 秒才返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():  <span style="color:#75715e">// 这个分支永远不会被触发</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>结果</strong>：超时控制完全失效，函数依然会等待 10 秒。</p>
<h2 id="使用-goroutine-的原因">使用 goroutine 的原因</h2>
<h3 id="-正确的实现">✅ <strong>正确的实现</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">result</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在新的 goroutine 中执行阻塞的 singleflight.Do()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)  <span style="color:#75715e">// 10 秒的阻塞操作</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将结果发送到 channel</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 主 goroutine 可以在这里等待两个事件：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:          <span style="color:#75715e">// singleflight 完成</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():         <span style="color:#75715e">// 超时</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()  <span style="color:#75715e">// 5 秒后返回超时错误</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="执行流程对比">执行流程对比</h2>
<h3 id="没有-goroutine-的执行流程"><strong>没有 goroutine 的执行流程</strong>：</h3>
<pre tabindex="0"><code>1. 开始执行 GetUserWithTimeout()
2. 调用 g.Do() -&gt; 阻塞 10 秒
3. 10 秒后 g.Do() 返回
4. 执行 select（但此时已经超过 5 秒了）
5. 返回结果（超时控制失效）
</code></pre><h3 id="使用-goroutine-的执行流程"><strong>使用 goroutine 的执行流程</strong>：</h3>
<pre tabindex="0"><code>主 goroutine:                    新 goroutine:
1. 创建 channel                  
2. 启动 goroutine               -&gt; 3. 执行 g.Do()（阻塞 10 秒）
4. 进入 select 等待
5. 5 秒后 ctx.Done() 触发
6. 返回超时错误                 -&gt; （g.Do() 可能还在执行）
</code></pre><h2 id="实际的时序图">实际的时序图</h2>
<pre tabindex="0"><code>时间轴: 0s -------- 5s -------- 10s
       |           |           |
主线程: 启动 ----&gt; 超时返回      |
       |           |           |
新线程: g.Do()开始 -------- g.Do()完成
       |                       |
       |&lt;------ 阻塞 10 秒 ----&gt;|
</code></pre><h2 id="更直观的例子">更直观的例子</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demonstrateBlocking</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始时间:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 模拟不使用 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;调用 singleflight...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#e6db74">&#34;test&#34;</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始执行慢操作:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;慢操作完成:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;result&#34;</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;singleflight 返回:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 输出显示：从开始到这里经过了完整的 10 秒</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结-3">总结</h2>
<p>使用 goroutine 的原因是：</p>
<ol>
<li><strong><code>singleflight.Do()</code> 是阻塞的</strong>，会等待函数执行完成</li>
<li><strong>如果不使用 goroutine</strong>，超时检查的代码永远不会被执行到</li>
<li><strong>使用 goroutine</strong> 让阻塞操作在后台执行，主线程可以同时监听超时事件</li>
<li><strong>实现真正的超时控制</strong>，而不是假的超时控制</li>
</ol>
<p>这是并发编程中一个经典的模式：<strong>将阻塞操作放到 goroutine 中，主线程负责协调和超时控制</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// singleflight.Do() 的行为</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这个函数可能执行很久</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)  <span style="color:#75715e">// 假设数据库查询很慢</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在函数执行完之前，这里不会被执行</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 直接调用，没有 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)  <span style="color:#75715e">// 假设这需要 10 秒</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 问题：这个 select 永远不会被执行到！</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 因为上面的 g.Do() 会阻塞 10 秒才返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():  <span style="color:#75715e">// 这个分支永远不会被触发</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserWithTimeout</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%s&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">result</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在新的 goroutine 中执行阻塞的 singleflight.Do()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">key</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetchUserFromDB</span>(<span style="color:#a6e22e">userID</span>)  <span style="color:#75715e">// 10 秒的阻塞操作</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将结果发送到 channel</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>{<span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>), <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 主 goroutine 可以在这里等待两个事件：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:          <span style="color:#75715e">// singleflight 完成</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():         <span style="color:#75715e">// 超时</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>()  <span style="color:#75715e">// 5 秒后返回超时错误</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>1. 开始执行 GetUserWithTimeout()
</span></span><span style="display:flex;"><span>2. 调用 g.Do() -&gt; 阻塞 10 秒
</span></span><span style="display:flex;"><span>3. 10 秒后 g.Do() 返回
</span></span><span style="display:flex;"><span>4. 执行 select（但此时已经超过 5 秒了）
</span></span><span style="display:flex;"><span>5. 返回结果（超时控制失效）
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>主 goroutine:                    新 goroutine:
</span></span><span style="display:flex;"><span>1. 创建 channel                  
</span></span><span style="display:flex;"><span>2. 启动 goroutine               -&gt; 3. 执行 g.Do()（阻塞 10 秒）
</span></span><span style="display:flex;"><span>4. 进入 select 等待
</span></span><span style="display:flex;"><span>5. 5 秒后 ctx.Done() 触发
</span></span><span style="display:flex;"><span>6. 返回超时错误                 -&gt; （g.Do() 可能还在执行）
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>时间轴: 0s -------- 5s -------- 10s
</span></span><span style="display:flex;"><span>       |           |           |
</span></span><span style="display:flex;"><span>主线程: 启动 ----&gt; 超时返回      |
</span></span><span style="display:flex;"><span>       |           |           |
</span></span><span style="display:flex;"><span>新线程: g.Do()开始 -------- g.Do()完成
</span></span><span style="display:flex;"><span>       |                       |
</span></span><span style="display:flex;"><span>       |&lt;------ 阻塞 10 秒 ----&gt;|
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demonstrateBlocking</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始时间:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 模拟不使用 goroutine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;调用 singleflight...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#e6db74">&#34;test&#34;</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始执行慢操作:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;慢操作完成:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;result&#34;</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;singleflight 返回:&#34;</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 输出显示：从开始到这里经过了完整的 10 秒</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
  <p class="copyright">
    Copyright © 2025
    <a href="http://localhost:1313/"><strong>Blog Author</strong></a>.
    This work is licensed under the
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
  </p>
  <p class="builtWith">
    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>,
    which was influenced by the theme
    <a href="https://github.com/sumnerevans/smol">smol</a>.
  </p>
</footer>

    </div>
  </body>
</html>
